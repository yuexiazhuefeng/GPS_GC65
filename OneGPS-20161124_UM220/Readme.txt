/*********************************************************************************************************
*
* File                : Readme.txt
* Version             : V1.0
* By                  : ZZG
* 
*
*********************************************

20150723: 短信和串口设置测试完成
20150727: 定时唤醒功能测试无误,原来设置RTC ALARM的时候的BCD和BIN搞错了
20150730: GPRS的指令都过了一遍，把有bug的地方改好了
20150804: 振动功能实现了，原来有个电阻没焊好。
20150807: 中文指令的gprs ID由0x0f00->0x0f88
20150817: 增加短信断油电、设置振动灵敏度，复位。
20150822: 振动灵敏度默认值改成最大档 3档；改正系统从外部供电切换到电池时，紧急报警误触发的问题。
20150827: CSCX指令SMSON状态显示成ACCON了，今天改正了。
20150906: GPS不定位重启等待时间从20秒改成250秒。同时GPS速度大于300Km/h时，认为数据无效，当前的GPRS上传数据取消。
20150907: 北斗王中王GPS增加不接外电也紧急报警功能；为避免超大的速度值，将原来不定位但有经纬度也认为数据有效取消，
          只发有效定位的数据，未定位时发最后一个定位位置，内容中的定位标志改成0，速度和角度都改成0。
20150912: 版本号中增加了创建时的日期。
20150914: 休眠后通过振动、紧急报警、ACC（acc 功能打开时），发送的报警短信息所需的经纬度信息，改成不定位时用最后一个定位的经纬度。
20150916: 修改使用SSCOM进行串口设置出现的问题，查询版本没有换行、端口设置问题、查询IP换了2行。换行不对的原因：sscom显示的 “\r\n”数据前不能出现0x00。
20150916_1: 修改串口设置模式时，错误参数虽然不保存但会提示正确的BUG。改成提示“Wrong mode !”
20150916_2: 修改串口设置系统参数的等待时间从3秒等到5秒。
20150930: 增加对UM220 的北斗数据兼容功能
20151017: 修改北斗王中王程序，所有的重启GPRS前的超时时间都加大了。例如，加大短信设置指令SETM的超时时间，具体位置在“设置完成”与“发送关闭UDP通道AT指令”之间，从1ms－>2500ms。
20151019: 修改<CSZD>会重启的问题。
20151027: 取消GPS重启，原来不定位时间超过5分钟就重启了。短信指令<CSKMG>中，先关闭gps电源，再等看门狗复位，系统重启。
20151031: 修正紧急报警不报的问题，增大系统栈的大小，从0X1000->0X1200。
20151102: 修正紧急报警不报的问题，增大系统栈的大小，从0X1200->0X1400。
20151103: 改正长时间按住紧急报警会死机重启的问题,取消主循环中的紧急报警处理的延时函数,使用定时器中断中处理延时.系统栈的大小，从0X1400->0X1000.
20151106: 增加gsm 120秒都收不到服务器的消息,就重启GSM.
20151109: 在串口设置参数前先开启GSM,让GSM的TX的电平保持高电平,防止干扰MCU。delayms函数中的喂狗动作改放在循环外，以防万一.
20151110: 修改GSM的UART IO口配置，将RX的上拉改成浮空。把上电指示的闪灯动作从参数设置完成后改到IO初始化之后，保证上电后立即闪灯。
20151110_1: 在串口设置参数前先开启GSM,powerkey延时加长，避免还有无法启动的现象。
20151110_2: 所有修改IP 端口的指令，都会重启GSM模块，防止切换不成功。
20151124: 上电后GSM不上线重新拨号三次，直接进入主循环，GPS定位会亮GPS灯，原来如果一直不上线就会MCU复位，这样安装时可以看到GPS的定位情况。
20151201: 断油电操作前先写参数，参数完成了再操作继电器,防止丢ID。
20151204: 修正每天0：00～7：59　日期延迟一天的问题。修正超速报警短信号码不正确的问题。
20151207：增加里程统计和车辆跟踪功能。
20151208：短信报警信息的时间从格林威治时间改成北京时间。
20151209: 修改延时函数，防止死机导致看门狗复位。里程统计条件改变了，从每秒无条件计算改成必须打开ACC功能同时ACC的状态有效时才计算。存贮间隔设为5分钟，可以存25年。
20151217: 改变里程统计在程序中的执行位置，从主循环中改到定时中断中，改善里程统计的精确度。
20151229: 增加中科微AGPS操作，如果GPS先定位，将取消AGPS操作；增加两分钟GPS未定位就发送0F89基站定位信息。
20151231: AGPS用户名密码从每秒五千次限制的改成不受限的。
20160106: 加上一个开关，这个开关打开了才能重设置IP和端口。这个开关只能在出厂串口指令里设置；同时恢复出厂时也要保存这个标志，如果是固定IP的，还要保留IP和端口。
20160129: 修复有时基站位置不发的BUG,开机或超低功耗下唤醒后，一次都没有定位过，不定位就传基站；定位过，再连续2分钟不定位才传基站。
///////////////////////////////////////////////////////wei
20160509:加了震动中断次数统计变量。
	 57服务器改为54服务器
	 加了GC65的读版本(ATI),设置除了短信和电话外不要RING中断 AT+QICFG="RI/Hopping",1
20160511:完成数据通道的调整，通道2--发AGPS，通道1--FHTGPS
20160517:完成system_para结构体收动对齐，涉及到strlen的修改，没有测试。
	修改store_System_Para()函数，为处理存储正常区和备份区函数
	添加备份区处理子函数，u8 Backup_Store_System_Para(void)
	将原来的store_System_Para()函数改为u8 Set_Store_System_Para(void)，操作正常的参数存储区
	建立u8  FLASH_ErasePage_Complete(u32 *addr)函数
	完成开机参数初始化逻辑修改。
20160518:修改写完后比较程序，指针ptmp +=4;  ptmp_system_para += 4;--->ptmp +=1;  ptmp_system_para += 1;已经被强制转换成指向u32 *的了，故+1就会移4个字节。
	此时，主程序的CODE区结束位置为	DCB4	            
20160520:改善GPS超速短信报警频繁，只有触发一次才发送，触发后维持，则不报。(只有在处理上报位置信息的时候才有对GPS数据的处理，才会去判断是不是有超速，所以反应可能有点迟钝)
20160521:修改超低功耗唤醒后机器正常工作情况下，灯不亮。增加短信超速报警过滤，只有触发才报警，维持不报警
20160523:将里程统计，放到中断里面做，里程超过2公里，存一次(以前是5min存一次).
20160524:里程提取放到串口里面，里程累加放到SYSTICK定时器里面。ACC检测增加用扫描方式得到ACC状态，涉及到ACC中断的部分不动，
20160525:SYSTICK定时器里面里程累加之前，加一个速度的判断，如果速度大于220km/h,则认为是非法的。
20160530:定义bit_flag标志量，位0,1同时为1则表示在请求AGPS数据。
20160531:添加Check_AT()函数，上电后先判断AT返回情况，有返回，就不重启GSM,没返回，再重启。之前是上电就重启GSM
20160601:
	1、GSM开机不成功，就一直开操作开机。
	2、请求AGPS的时候，将fb5，AGPS_ov清零。
	3、修改 GetAvailableGPSInfoV_N()内部，有两次检测到定位就返回，之前是3次
	4、修改执行StartGPRStoAGPS()拨号前，判断一下啊GPS是否定位，定位就不拨了
	5、修改执行test_a_gps()请求数据前，判断一下啊GPS是否定位，定位就不拨了
	6、增加TCP链路状态判断，如果链路断开，就重新拨号
20160603:
	1、增加震动芯片异常判断，如果中断线的电平连续5秒一直是低的，就再次初始化震动芯片。
	2、强制限制心跳间隔不能小于10s
20160604:
        1、恢复短信故障。
20160607:1、补全20160605版的，防止休眠后无法震动唤醒问题。进入睡眠和出睡眠的时候都要将初始化震动芯片的标志量清零。
需要初始化，和在初始化，变量分开，震动中断中只判断在初始化，才屏蔽中断，否则不屏蔽。
	2、市场部测试发现唤醒后无法上线，老版程序中在唤醒后有一个死循环在一直拨号。改成连续两次拨号不成功，就断电重启GSM.
20160608:
	1、添加ACC有电时不会休眠，ACC断电后开始计时工作时间，到了设定的工作时长再睡眠。
	2、平台点名，如果没有GPS上发基站信息，之前是上发通用应答
	3、修改唤醒时对GSM的处理逻辑，唤醒后直接给GSM上电，不会先断电再上电。
	4、注释掉低功耗的程序，现在程序中只有超低功耗的程序。	
20160612:
	1、修改短信测试看门狗时,对GSM的下电处理，看门狗复位时间是20秒，在这20内保证完成短信的发送，和GSM的下电时序
	2、在需要使用看门狗的地方，使用看门狗复位前，加一个GSM的下电函数。
	3、将PB5震动检测脚改为使用单片机内部上拉。
	4、注释掉震动异常再次初始化函数。
20160625
	1、完成SET_APN()设置APN的子程序。
20160705
	1、1号机，修改APN,USERNAME,PSW的存储长度，原来的都是用数字直接写的，将其替换成宏方便以后修改。
	2、修改网络参数的处理程序，串口设置，短信设置，平台设置，有些子程序的处理有bug。
20160708
	1、完成APN,USERNAME,PSW的存储长度测试，将存储长度由数字替换成宏，多修改三个数组smsbuf[130],g_ucSim900Buff[512],smsdatareg._smscontent[130]短信，串口，平台，都可以。
	2、修改GetGPRSStatus()函数，增加#define GRPS_IP_PORT_err 3  #define GPRS_CONNECTED_AGPS  2
20160711
	1、调整短信接收流程，拨号前会判断一次短信接收标志。
	2、劫警引起的休眠时间重新计算，放到消抖程序里面做。
20160712
	1、改劫警，触发后立即上报一条，然后，如果维持，则间隔10秒发送一次，发送5次，之后就只随位置信息上报。
20160801
	1、注释掉，void Cmd_NoLimit(void)，void Cmd_ReadSpeedLimit(void)，void Cmd_DelNum(void)删掉，短信设为全0，则为删除特权号
	2、震动，加上默认高电平设置。
20160802	
	1、整理1号机的程序，将串口初始化程序，ddi_uart_init做成两个子程序ddi_uart1_init，ddi_uart2_init，腾出120字节。
20160803
	1、void Cmd_SetUpTime(void)，void set_GSM_SLEEP(bool status),void DTR_PIN_MODE_Contrl(FunctionalState New_state),注释掉这些函数
	2、注释掉低功耗模式的相关代码，低功耗时的处理程序，DTR脚的控制程序，AT+QSCLK程序。
20160809
	1、将短信容许等待时间设为10秒，WaitGSMOK2(50)-->WaitGSMOK2(500)
20160813
	1、完成GPS时间基准，和GSM的时间基准。完成了RTC走时，误差调整到1小时内误差1秒
	2、分离成功GPS的处理函数，通过调用GPS子函数，也能正常收发数据。
	3、改void LMS330DLC_AccSetThreshold(int16_t nData)震动初始化用到的函数switch(ctrl4 & 0x03)
20160822
	1、根据0x0200的数据结，完成0x0f90基站位置的数据结构，具体看修改的协议。
20160823
	1、欠压调整为10.5-9V
	2、调整上发位置使用基站还是GPS的判断标志量和判断位置，在0x0200使用send_gps_gsm_flag = GPS_FLAG GSM_FLAG
20160824
	1、调整点名是应答基站位置的上报方式，和主动上发指令一样，不要加应答流水号，防止服务器检测混乱
	2、调整GPS不定位120秒后切换成基站。
20160825
	1、ACC关抑制漂移。只发最后一个经纬度。ACC开关使能，且ACC是关闭的状态下发最后一条GPS,如果是基站则当有GPS信号是会切换到发送一个GPS并一直使用这个GPS。点名会更新最后一次定位，临时追踪会实时更新位置信息

20160826
	1、调整AGPS处理方式，GSM使用9600波特率，GPS使用115200波特率。
	2、提出AGPS里面的GSM/网络形成的分包数据，完善数据内容。
20160829
	1、注释掉，5min存一次里程。
	2、添加GPS校验，
20160831
	1、优化里程存储流程，
	2、注释掉GPS冷启动语句
	3、增加GPS异常处理
20160903
	1、优化震动判断，及上报逻辑。有震动报警。立即上发。
	2、优化GPS处理，避免发短信上报的位置信息错误
	3、使用0级优化。
	4、震动过滤，8秒没有震动算一次。
	5、for(i=0;i<500,i++)有4处，替换，减小代码量
20160904
	1、修改震动，加8秒间隔判断，震动之后要有8的不震动，才能有效检测到下一次的震动
	2、修复刘萍萍反应的，超速没有扩展字段
20160907
	1、修改复位问题，待验证
	2、修改方向问题，待验证
	3、修改<CXZD>GPS的处理方法，待验证
20160908
	1、修复基站点名上报有吴
	2、添加SIM卡错误判断
20160909
	1、修改基站时间不对问题。	
	2、修改ACC打开后就关，震动会一直报的问题
	3、整理CGATT程序，做成子函数
	4、添加在ACC关掉的时候触发一次里程存储动作。
	5、调整GPS定位标志，和定位过标志的置位和清零。在收到完整时间的地方置位，串口中三次接收错误将定位标志清零。

整理空间找的关键字
1、  ddi_uart_Write(&UART1_ctl_t,"AT+CGATT?\r",strlen("AT+CGATT?\r"));
2、  if (BUSY == g_ucSim900Status)
20160918
	1、修改GPS不定位的两分钟内，纬度为0的问题。
	2、添加基站定位时的短信请求中文位置功能。
	3、修改内部固化的震动灵敏度，2603改为3603
20160919
	1、修改震动参数，将原来的7907 5805 2603 改为6603 5003 3403
20160920
	2、修复AGPS的eph为full
	3、GPS切换基站不用过滤不定位的情况
	4、gps获取次数函数间隔有1秒改为0.7秒
	5、修复acc开关没打开时会有震动报警的bug
20160921
	1、在CGATT和COPS里面添加CPIN READY判断，在StartGPRS和StartGPRStoAGPS里面加CPIN READY判断，如果标志量有效才拨号，否则退出。
	2、将CGREG提到CGATT的前面去做。
	3、断油电时上报位置方式优化，基站也报。以及相当于点名会更新位置信息。
	4、请求AGPS数据的时候，加CPIN READY判断重启。
	
20160926
	1、震动灵敏度，最灵敏档设为由3403改为4203
	2、修改Cmd_NewNum，单条短信设置号码函数，修改sub_cxcs函数中的提取号码部分代码，修改Cmd_ShowRegNum单独查询号码函数。
	3、使用SendMsg_Parameter_error和SendMsg_Password_error代替原来重复使用的参数错误和密码错误发送代码。
20160927
	1、修改串口设置和删除特权号程序。短信接收时的号码长度由原来的固定11位，改成动态长度，最大28位。
20160928
	1、修改短信报警程序，修改特权号码的判断方式，判断长度是否符合，标志量是否符合
	2、修改查询指令函数，增加长度判断，如果超长，只发单条短信的最大长度部分。
	3、增加sif4 GPS模块的兼容
	4、修改紧急报警的标志位清零的地方，保证触发后会上报一次。
20160929
	1、修复超速报警
20161108
	1、附着网络前，先判断获取网络运营商情况，获取不到则退出，从来一次，连续两个循环都没有成功，则重启模块。
20161111
	1、针对唤醒是出现的复位现象。延长过滤时间，避开给GSM上电时的不稳定电平。

2016-11-22
	1、根据朱工要求，去掉震动芯片，采用宏开关的方式做裁剪。
	2、在user_define.h中做震动功能使能宏开关#define ENSHOCK。该宏如果定义了，就使能震动功能，否则不使能震动。
2016-11-23
	1、修复唤醒MCU指示灯不亮，
	2、延长GSM掉线判断时间为4min	

2016-11-24
	1、开始做UM220的AGPS，开辟2K的空间。
	2、再次将堆栈的空间从4K减到2K，腾出2K给AGPS缓存。
2016-11-25
	1、使用环形指针发送APGS数据，测试效果不好。
2016-12-01
	1、UM220的APGS数据请求，转发成功，目前使用的1550字节的缓存。
	2、UM220和别的GPS模块区分，兼容UM220和ATGM332D模块，GPS使用9600，GSM使用9600
	3、获取APGS数据的时候，GSM的数据不使用主动上报，在使用AT+QIRD请求的时候，才会发(这里的问题是，中科微的服务区，在发送完数据后会立即关闭TCP连接，导致链路关闭，链路关闭导致GC65模块内部的缓存数据丢失，此时再发AT+QIRD，会返回ERROR。这样的结果是，中科微的模块只能收到第一包APGS数据，影响定位速度。因为UM220的服务器使用的是UDP连接，不会出现这个问题，数据可以完整接收和转发)。
	4、此版本的缺点就是，只能收到中科的第一包数据。
2016-12-02
	1、AGPS缓存还是使用384字节，转发采用循环发送，来一个就发一个，GPS和GSM都使用9600
	2、三版程序兼容，不要震动的话，就直接把震动控制宏注释掉，三个模块的GPS都能使用。

2016-12-17
	1、修复终端通用应答数据错乱问题。



















